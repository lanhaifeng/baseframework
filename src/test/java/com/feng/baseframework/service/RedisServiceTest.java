package com.feng.baseframework.service;

import com.alibaba.fastjson.JSONObject;
import com.feng.baseframework.common.JunitBaseTest;
import com.feng.baseframework.model.Role;
import com.feng.baseframework.util.StringUtil;
import org.json.JSONException;
import org.junit.Assert;
import org.junit.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.StringUtils;

import java.util.*;
import java.util.concurrent.atomic.AtomicLong;

public class RedisServiceTest extends JunitBaseTest {

    @Autowired
    private RedisService redisService;

    @Test
    public void remove() {
    }

    @Test
    public void setTimeOut() {
        redisService.set("test","test",1*60*1000l);
        try {
            Thread.sleep(30*1000l);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        redisService.set("test","test",1*60*1000l);
        try {
            Thread.sleep(40*1000l);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(redisService.get("test"));
    }

    @Test
    public void set1() {
    }

    @Test
    public void get() {
    }

    @Test
    public void multiSetList() {
        redisService.changeDb(1);
        String listName = "listTest";
        Collection<String> listData = new ArrayList<>();
        listData.add("list1");
        listData.add("list2");
        listData.add("list3");
        listData.add("list4");
        listData.add("list5");
        listData.add("list6");

        redisService.multiSetList(listName,listData);
    }

    @Test
    public void getRightListMultValueAfterDel() {
        multiSetList();
        redisService.changeDb(1);
        String listName = "listTest";
        List<Object> data =redisService.getRightListMultValueAfterDel(listName,8);
        if(data == null){
            return;
        }
        for (Object obj : data){
            System.out.println(obj);
        }
    }

    @Test
    public void getLeftListMultValueAfterDel() {
        multiSetList();
        redisService.changeDb(1);
        String listName = "listTest";
        List<Object> data =redisService.getLeftListMultValueAfterDel(listName,8);
        if(data == null){
            return;
        }
        for (Object obj : data){
            System.out.println(obj);
        }
    }

    @Test
    public void getHashMultValue() {
        String hashName = "hashTest";
        Set<String> keys = new HashSet<>();
        for(int i=0;i<100;i++){
            keys.add(String.valueOf(i));
            if(i==97){
                keys.add(String.valueOf(10001));
            }
        }
        keys.add(String.valueOf(10000));
        List<Object> data =redisService.getHashMultValue(hashName,keys,false);
        for(Object obj : data){
            if(obj instanceof Map){
                System.out.println("data is map!");
            }
            if(obj instanceof String){
                System.out.println(obj);
            }
        }
    }

    @Test
    public void getHashMultValue2() {
        Set<String> keys = new HashSet<>();
        keys.add("");
        List<Object> bizLogStr = redisService.getHashMultValue("BizzLogInLog",keys,false);
    }

    @Test
    public void setHashMultValue() throws JSONException {
        String hashName = "hashTest";
        Map<String,String> data = new HashMap<>();
        JSONObject jsonObject = null;
        for(int i=0;i<1000;i++){
            jsonObject = new JSONObject();
            jsonObject.put("id",StringUtil.generateUUID());
            jsonObject.put("name","name"+i);
            jsonObject.put("age","age"+i);
            jsonObject.put("sex","sex"+i);
            data.put(String.valueOf(i),jsonObject.toString());
        }

        redisService.setHashMultValue(hashName,data);
    }

    @Test
    public void sendLogonToRedis() throws JSONException {
        //language=JSON
        String jsonObject = "{\n" +
                "  \"LinkSession\":{\n" +
                "    \"linkSessionID\": \"10776909922302503157\",\n" +
                "    \"DBID\": 31,\n" +
                "    \"dbStatus\": \"1\",\n" +
                "    \"serverHostName\": \"os\",\n" +
                "    \"dbServerName\": \"orcl\",\n" +
                "    \"serverIP\": \"192.168.202.3\",\n" +
                "    \"serverPort\": 1521,\n" +
                "    \"dataType\": \"1\",\n" +
                "    \"fromAddress\": \"172.19.1.7\",\n" +
                "    \"fromType\": \"1\",\n" +
                "    \"remoteClientProtocol\": \"SSH\",\n" +
                "    \"remoteClientIP\": \"192.168.61.17\",\n" +
                "    \"remoteClientAPPName\": \"SSH\",\n" +
                "    \"remoteClientMac\": \"\",\n" +
                "    \"remoteClientHost\": \"DELL\",\n" +
                "    \"clientHostName\": \"DELL\",\n" +
                "    \"clientOSName\": \"WIN7\",\n" +
                "    \"clientOSUser\": \"LJH\",\n" +
                "    \"clientAppName\": \"SQLPLUS\",\n" +
                "    \"clientMAC\": \"08-62-66-7F-AC-65\",\n" +
                "    \"clientIP\": \"192.168.61.225\",\n" +
                "    \"clientPort\": 60220,\n" +
                "    \"userSession\": {\n" +
                "      \"dbInstanceName\": \"orcl\",\n" +
                "      \"defaultDB\": \"DEPT\",\n" +
                "      \"defaultSchema\": \"HR\",\n" +
                "      \"dbUserName\": \"asset\"\n" +
                "    },\n" +
                "    \"token\": \"\",\n" +
                "    \"eUser\": \"\",\n" +
                "    \"eUserID\": \"\",\n" +
                "    \"eUserName\": \"\",\n" +
                "    \"certName\": \"\",\n" +
                "    \"appHash\": \"\",\n" +
                "    \"appPath\": \"\",\n" +
                "    \"appUser\": \"\",\n" +
                "    \"logInTimeStamp\": 139674484032992000,\n" +
                "    \"isLogInSuccess\": true,\n" +
                "    \"logOutTimeStamp_\": 0\n" +
                "  },\n" +
                "  \"SQLSession\":{\n" +
                "    \"linkSessionID\":\"10776909922302503157\",\n" +
                "    \"SQLSessionID\":\"1534149565350659\",\n" +
                "    \"SQLID\":\"155553235\",\n" +
                "    \"SQLBind\":[\"a\",\"b\",\"c\"],\n" +
                "    \"reqTimeStamp\":139674484032992000,\n" +
                "    \"resTimeStamp\":139674484062992000,\n" +
                "    \"resRow\":10,\n" +
                "    \"errorCode\":\"0\"\n" +
                "  },\n" +
                "  \"SQLResource\":{\n" +
                "    \"SQLID\":\"155553235\",\n" +
                "    \"SQLParserType\":\"1\",\n" +
                "    \"SQLType\":\"SELECT\",\n" +
                "    \"SQLOriginal\":\"SELECT col1,col2,col3 from tab where col4='a' and col5='b' and col6='c'\",\n" +
                "    \"SQLNormalization\":\"SELECT col1,col2,col3 from tab where col4=? and col5=? and col6=?\",\n" +
                "    \"readTableColumn\":[{\n" +
                "      \"database\":\"\",\n" +
                "      \"schema\":\"\",\n" +
                "      \"table\":\"\",\n" +
                "      \"column\":\"\"\n" +
                "    }],\n" +
                "    \"writeTableColumn\":[{\n" +
                "      \"database\":\"\",\n" +
                "      \"schema\":\"\",\n" +
                "      \"table\":\"\",\n" +
                "      \"column\":\"\"\n" +
                "    }]\n" +
                "  },\n" +
                "  \"BizzAccessLog\":{\n" +
                "    \"linkSessionID\":\"\",\n" +
                "    \"SQLSessionID\":\"1534149565350659\",\n" +
                "    \"token\":\"\",\n" +
                "    \"eUser\":\"\",\n" +
                "    \"eUserID\":\"\",\n" +
                "    \"eUserName\":\"\",\n" +
                "    \"certName\":\"\",\n" +
                "    \"dbWorkMode\":\"1\",\n" +
                "    \"content\":{\n" +
                "      \"accessControl\":{\n" +
                "        \"ruleName\":\"SPS_IPADDRESS_LOGON1\",\n" +
                "        \"actionLevel\":\"1\",\n" +
                "        \"auditLevel\":\"1\",\n" +
                "        \"riskLevel\":\"1\",\n" +
                "        \"objectOwner\":\"asset\",\n" +
                "        \"objectName\":\"EMPTY_COLUMN\",\n" +
                "        \"objectType\":\"TABLE\"\n" +
                "      },\n" +
                "      \"dataMask\":{\n" +
                "        \"maskRuleName\":\"maskRuleName1\"\n" +
                "      },\n" +
                "      \"riskEngine\":[\n" +
                "        {\n" +
                "          \"ruleName\":\"riskRuleName1\",\n" +
                "          \"actionLevel\":\"2\",\n" +
                "          \"auditLevel\":\"1\",\n" +
                "          \"riskLevel\":\"2\",\n" +
                "          \"riskClass\":202,\n" +
                "          \"tag\":[\"q\",\"b\"],\n" +
                "          \"matched\":[\"dsfsd\",\"dsgdsf\"]\n" +
                "        },\n" +
                "        {\n" +
                "          \"ruleName\":\"riskRuleName2\",\n" +
                "          \"actionLevel\":\"3\",\n" +
                "          \"auditLevel\":\"2\",\n" +
                "          \"riskLevel\":\"3\",\n" +
                "          \"riskClass\":203,\n" +
                "          \"tag\":[\"q2\",\"b2\"],\n" +
                "          \"matched\":[\"dsfsd2\",\"dsgdsf2\"]\n" +
                "        }\n" +
                "      ]\n" +
                "    }\n" +
                "  },\n" +
                "  \"BizzLinkLog\":{\n" +
                "    \"linkSessionID\":\"10776909922302503157\",\n" +
                "    \"SQLSessionID\":\"\",\n" +
                "    \"token\":\"\",\n" +
                "    \"eUser\":\"\",\n" +
                "    \"eUserID\":\"\",\n" +
                "    \"eUserName\":\"\",\n" +
                "    \"certName\":\"\",\n" +
                "    \"dbWorkMode\":\"1\",\n" +
                "    \"content\":{\n" +
                "      \"accessControl\":{\n" +
                "        \"ruleName\":\"SPS_IPADDRESS_LOGON\",\n" +
                "        \"actionLevel\":\"1\",\n" +
                "        \"auditLevel\":\"1\",\n" +
                "        \"riskLevel\":\"3\",\n" +
                "        \"objectOwner\":\"\",\n" +
                "        \"objectName\":\"\",\n" +
                "        \"objectType\":\"\",\n" +
                "        \"lockDestination\":{\n" +
                "          \"id\": 1,\n" +
                "          \"ip_address\": \"192.168.61.15\",\n" +
                "          \"host\": \"CPT\",\n" +
                "          \"flcnt\": 1,\n" +
                "          \"locked_date\": \"2018-09-03 16:55:25\",\n" +
                "          \"dbid\": 1\n" +
                "        }\n" +
                "      },\n" +
                "      \"dataMask\":{\n" +
                "        \"maskRuleName\":\"maskRuleName1\"\n" +
                "      },\n" +
                "      \"riskEngine\":[\n" +
                "        {\n" +
                "          \"ruleName\":\"riskRuleName1\",\n" +
                "          \"actionLevel\":\"2\",\n" +
                "          \"auditLevel\":\"1\",\n" +
                "          \"riskLevel\":\"2\",\n" +
                "          \"tag\":[\"q\",\"b\"],\n" +
                "          \"matched\":[\"dsfsd\",\"dsgdsf\"]\n" +
                "        },\n" +
                "        {\n" +
                "          \"ruleName\":\"riskRuleName2\",\n" +
                "          \"actionLevel\":\"3\",\n" +
                "          \"auditLevel\":\"2\",\n" +
                "          \"riskLevel\":\"1\",\n" +
                "          \"riskClass\":203,\n" +
                "          \"tag\":[\"q2\",\"b2\"],\n" +
                "          \"matched\":[\"dsfsd2\",\"dsgdsf2\"]\n" +
                "        }\n" +
                "      ]\n" +
                "    }\n" +
                "  }\n" +
                "}";
        JSONObject data = JSONObject.parseObject(jsonObject);
        String linkSessionId = StringUtil.generateUUID();
        String sqlSessionId = StringUtil.generateUUID();
        String sqlId = StringUtil.generateUUID();
        JSONObject linkSession = data.getJSONObject("LinkSession");
        JSONObject bizzLogInLog = data.getJSONObject("BizzLinkLog");
        linkSession.put("linkSessionID",linkSessionId);
        bizzLogInLog.put("linkSessionID",linkSessionId);

        JSONObject sqlSession = data.getJSONObject("SQLSession");
        JSONObject sqlResource = data.getJSONObject("SQLResource");
        JSONObject bizzLog = data.getJSONObject("BizzAccessLog");
        sqlSession.put("SQLSessionID",sqlSessionId);
        sqlSession.put("SQLID",sqlId);
        sqlSession.put("linkSessionID",linkSessionId);
        sqlResource.put("SQLID",sqlId);
        bizzLog.put("SQLSessionID",sqlSessionId);

        System.out.println(data.toString());
        System.out.println("linkSession:"+linkSession.toString());
        System.out.println("BizzLinkLog:"+bizzLogInLog.toString());
        System.out.println("sqlSession:"+sqlSession.toString());
        System.out.println("sqlResource:"+sqlResource.toString());
        System.out.println("BizzAccessLog:"+bizzLog.toString());

        String logonHashKey = "LinkSession";
        String logonBizlogHashKey = "BizzLinkLog";
        String logonTopic = "LinkSession";

        String accessListKey = "SQLSession";
        String accessReourceKey = "SQLResource";
        String accessBizlogHashKey = "BizzAccessLog";
        String accessTopic = "SQLSession";

        //发送登陆审计
        Map<String,String> logonBizzlogHashData = new HashMap<>();
        logonBizzlogHashData.put(linkSessionId,bizzLogInLog.toString());

        Map<String,String> logonHashData = new HashMap<>();
        logonHashData.put(linkSessionId,linkSession.toString());

        redisService.setHashMultValue(logonBizlogHashKey,logonBizzlogHashData);
        redisService.setHashMultValue(logonHashKey,logonHashData);

        //通知
        redisService.convertAndSend(logonTopic, linkSessionId);

        //发送访问审计
        Map<String,String> accessBizzlogHashData = new HashMap<>();
        accessBizzlogHashData.put(sqlSessionId,bizzLog.toString());

        List<String> accessListData = new ArrayList<>();
        accessListData.add(sqlSession.toString());

        Map<String,String> sqlResourceHashData = new HashMap<>();
        sqlResourceHashData.put(sqlId,sqlResource.toString());

        redisService.multiSetList(accessListKey,accessListData);
        redisService.setHashMultValue(accessBizlogHashKey,accessBizzlogHashData);
        redisService.setHashMultValue(accessReourceKey,sqlResourceHashData);

        //通知
        redisService.convertAndSend(accessTopic,sqlSessionId);
    }

    @Test
    public void convertAndSend() {
        String logonHashKey = "LinkSession";
        List<String> messages = new ArrayList<>();
        messages.add(StringUtil.generateUUID());
        messages.add(StringUtil.generateUUID());
        messages.add(StringUtil.generateUUID());
        messages.add(StringUtil.generateUUID());

        redisService.convertAndSend(logonHashKey,messages);
    }

	@Test
	public void getHashCount() {
        String logonHashKey = "LinkSession1";
        Long count = redisService.getHashCount(logonHashKey);
        System.out.println(count);
	}

    @Test
    public void getHashKeys() {
        String logonHashKey = "LinkSession";
        Set<String> keys = redisService.getHashKeys(logonHashKey);
        System.out.println((keys == null || keys.isEmpty()) ? "LinkSession表为空" : ("键:" + StringUtils.collectionToCommaDelimitedString(keys)));
    }

    @Test
    public void mutlGetHash(){
        String logonHashKey = "LinkSession";
        AtomicLong onlineClientCount = new AtomicLong(0);
        int limitSize = 10;
        Set<String> keys = redisService.getHashKeys(logonHashKey);
        Set<String> logonKeys = new HashSet<>();
        List<Object> linkSessionStrs = null;

        //LinkSession为空，在线客户端为0
        if(keys == null || keys.isEmpty()){
            System.out.println(onlineClientCount.toString());
            return;
        }

        //LinkSession不为空，并不大于1000条
        if(keys.size() <= limitSize){
            linkSessionStrs = redisService.getHashMultValue(logonHashKey,keys,false);
            if(linkSessionStrs != null && !linkSessionStrs.isEmpty()){
                for(Object data : linkSessionStrs){
                    JSONObject linkSession = JSONObject.parseObject(data.toString());
                    if(!(linkSession.getLong("logOutTimeStamp_") > 0)){
                        onlineClientCount.incrementAndGet();
                    }
                }
            }
        }

        //LinkSession不为空，并大于1000条
        if(keys.size() > limitSize){
            int sum = 0, count = 0;
            Iterator<String> iterator = keys.iterator();
            while (iterator.hasNext()){
                if(count == limitSize || sum == keys.size()){
                    linkSessionStrs = redisService.getHashMultValue(logonHashKey,logonKeys,false);
                    if(linkSessionStrs != null && !linkSessionStrs.isEmpty()){
                        for(Object data : linkSessionStrs){
                            JSONObject linkSession = JSONObject.parseObject(data.toString());
                            if(!(linkSession.getLong("logOutTimeStamp_") > 0)){
                                onlineClientCount.incrementAndGet();
                            }
                        }
                    }

                    logonKeys.clear();
                    count = 0;
                }
                logonKeys.add(iterator.next());
                count++;
                sum++;
            }
        }
        System.out.println(onlineClientCount.toString());
    }

    @Test
    public void hexists() {
        System.out.println(redisService.hexists("SQLResource", "7893988940507880278"));
        System.out.println(redisService.hexists("SQLResource", "7893988940507880279"));
    }

    @Test
    public void getAll(){
        List<Object> datas = redisService.getRightListMultValueAfterDel("SQLSession", 1000);
        Set<String> keys = new HashSet<>();
        String keyStr = "4329317466924007576,13574337709005449103,2848800414249771564,7637440946257912303,1045036057961825601,10109282683543090155,9110216108224822551,11053567790742876462,2811438900953424485,2660780107588324795,8546337498039577161,11544870291920188859,3212744545503146213,3345095680788343370,2904464497657555138,2152957347304324350,16060034475500113410,2581114271377856859,15545947544286932250,4638977087921605341,17210336324128801210,1434146656940841756,16756688307470014046,18228466626957901701,1862679701716123158,3040873711853760638,10937260055216280106,17623162653659415764,3098159757542296768,5076030894122343333,15427290395910548646,4198879450766151702,14523221718515241401,9358902463328530444,10977834477679400535,12549150819775969808,7652051898266932507,3719753605610216609,13024351089393402898,5028924879666091913,10166802021484759514,4815311364891415275,2282582531013891470,2356578951173658952,16630919183280824759,347811218497878926,14850627528259214428,8029761023409698546,17792407874399554008,6259294240520419386,11856129058879006090,17391664956566364383,10800219013498440994,6908193578335045278,537090495909240992,8984144113084157046,4736346911602283904,2230021540316548433,17850931513856222283,3805320451727342577,1924073336856103721,14908452895740605215,4369364638592827331,8627862760635608143,171890738878850373,14546812567236226141,4687147707166324548,3092113079202871936,1832916482295443991,3039927383276496194,15683978547962441775,16683928754368532532,3115635465111755029,17885774311384937805,4305350969563289922,7755051279671099525,8837538258216518750,7800232924166488212,6070383717363819515,15975114519025166129,7571338654779864445,10331261526446127872,17624521237332340464,13715376084070031610,16434122333891109159,16293703710843999014,17001432831119744314,3265259145715697095,7476150209476458634,8991719149183145431,13911433659848975427,3775396443955923418,7294217907162379033,7996282735495365002,4763415952786791872,15836684253606624285,13644470852266584675,1080427978168022607,18030788197753737071,6430318230121959155,4655195820286235498,8103433642255207188,1936561689309207465,6841504781711974209,3399944621632233945,15498355875657846,10675783142349921839,17269232501412592952,17552943296962945171,6406379226379618362,4953837995594700556,13683896041278313300,13463288178271948556,6508759325624815654,14119371494511648312,12732671505475990857,14796945746586669908,5858576304910157512,5745839288936819029,3679650668297129404,14707106243608034514,3351807987380956776,1395360180903787137,5249100320694508330,332095412099099639,4859825789680857192,11403544115237304292,712374299517196051,4891346311819460532,457508819367543183,16281459211027216705,14947893785503408421,12306506460649619834,1783138259123703964,5298765611527847279,493111298452127798,1902059504995512149,14937368865090084199,12621805441936676733,12361972613936613047,5637943656634127930,3846988261345199696,4225837297023952014,5348558872272764875,4613177699382764895,10591949361199329859,4484809688863898539,2337167226165312892,14231731714913751599,7298993099704184160,9675369941302844784,7259540111207307315,1530657151072165841,598696651310812564,10290544482841362934,2269600102634046297,17320327404120055475,7384751350603644712,7409979252127772721,14917451775271732448,14379434968126320364,7221001291415435197,1562791024758769590,9386014847294906624,9886626808671298108,16271217737952811256,7161518826571237384,10021795035316684104,8205659450902920235,17508987248847520469,18413520681685412740,10443464736447470484,3330474011970684324,11464474247812602971,2961239856193531248,7980295607509304354,12824813070677543227,11935851402504957362,7235807430485983130,6716064351877453071,1668632529524081033,3740570874222432902,665504774293325468,8437591521756190487,9341660746777135310,224290544174385798,13130098180328410580,549307093870655273,18121362572553545474,13577761626439797133,4274157172290499480,1530467666382949332,10067717171454266385,6138029547786102634,14511641271387736112,8026390684329006213,927462168778453913,7393953329610482311,4919106048561923119,1696351787342052301,3280466213629263052,636523999337162827,14285761295686256553,513100885237375977,14111735388277236837,3461757870771769032,9502161489961972024,2769759370306545521,15368772269156366617,675876444463861940,14693829079072724520,13439163807615822458,4943927154036390309,2444513640926044990,15979418135502567120,8730187249012360082,18296796770062909960,13226259049315716687,4384559795258954781,832672267531922621,2727954051696821734,2862214617181639229,5500436966637598152,6560981997142733105,17955706699724609917,15100770413541227913,1345678294242723901,779236977561667758,12409383625601780844,17912792481719231563,16696379693431886734,15563679285405206879,12587391232044740706,13374488799651321633,10050884344531600824,7714918672414589785,14635007142143563862,7696627507716765273,18070589467331497515,3857098288034286001,18412183033413282020,16642050415482505909,14610497984098132133,5453888773268203711,4686334023513399849,6396597256789450651,11714089137310528874,17629745242669102023,3706806193463586102,3454698124156900018,16693521143796346100,5197597220497238697,11097422569572233317,8807389671677115695,12104404330116928564,17145224523827310434,9015114002711613588,16600955534951420648,14687916248739697683,7343776344486798762,5180131851279616700,9782094898180905282,8308821524090799753,16680861929360690418,558674584554487203,7461545831583469491,14487686430382049982,8230095462691211130,8502043736198191127,12593697784534986487,8433151327631738321,15708317260752867541,16124294239541070482,17986347833629064282,5835074642974019914,13794507425504441583,6214519466282761795,154168492092126219,7496504607578430173,10148480075064685232,3159019101507817597,6698113214605854462,12312269331994892936,11123401783381922171,14510678785620384482,4833834826687474540,7327473056317197059,2324938303959090093,16587673542089439012,2973176278294353814,15720909307656071602,15868533748821582810,12557429243603259929,665702185830082256,16145930564960462000,5941124141590520839,17522086489234439623,12433335884703888406,13173502051864914808,2879208978436807688,11375601423261705116,5151762047495174610,15751734175219704268,3772848947605076543,1679419024423462243,9080671429499264811,16105022428616080197,4244596249252977940,7620650820071403128,12795573080440528556,7836698493764079781,6948787042373646193,14394441580661408043,13942652943201341734,15968785228965310116,3403830114843370081,164622342418940816,7239175772162493274,13269466406303518656,3215646444291615065,5661427970221614934,810624220295383964,311534469905789822,6459048118413961870,7474073940528073148,14193788911953752819,13376999203097748487,10182675145025612834,9411192257174834682,3814263711913330092,9860460360742633449,2754879098596356593,10139778254063108406,15541506311545673248,12250744909547365373,4812819883494293783,13997223306387295058,13720150416533046293,3345576258850360453,12142025336329716284,10508000242339964083,1734255885723939935,2806936086296583320,17681313026006513127,1855465242314509722,9167751933156110434,5725494000686220128,9726198279937886041,10132824607247043250,7180597462461763361,11857771387836052249,12121141657728617625,7645724643051719567,9696612867077745912,16231070731624547879,16949710450448611140,13492454660977746235,18048695013668952964,18211312436193805423,7735945501755628098,3352151729688039627,16512310527490433951,3154176967380190248,12127363389513789881,3776757722399801765,10316332390634389649,1234841897773653008,7022598204040916940,6903778810122917751,16373423100084531837,17219190253125515654,2577787375692901497,10785476280591662432,3278416480871773285,1081555900616628636,13643141220710409139,16939929684790807798,1953191818335740943,11678932145330008386,5232637522223216808,4454167437250391997,1782250173970546067,15389481847047026876,6195722767040705226,5758959435230905416,16710019848133411664,14278122781534298320,11702491436793352160,10393284832044499659,15529203974911556041,13941236646405145720,12305398440529929346,16433585632739375904,1764749698848769850,746858258619739997,844762937936034361,12882708749619317486,18101272610064170835,6388106441574740727,4244317944270970710,13425765590965724237,17975497291648430600,12320051025369652210,16069307194140795758,7558425626672674552,4734613596794071250,3156260502740689725,13694983384049664504,13503225094767527214,3301655502241792079,8928514069798513895,6709108156424752355,5789645953190270548,13546615555637586154,8719093764312089017,13606656985460250770,14924871112561364822,11719247597192855204,7454470969076564065,11814779064881482006,229908143444734327,18402158713104845915,14949755681519671007,16591388153555010431,7563019059496466592,7371730652816030385,7519713832134604762,11999039037009386534,7958354758432775311,13836785628482791368,12958123503693730016,3420544674726213901,6586688472272358265,2146927721731872660,12316126509812850482,9632673317121832769,11991387588971207417,11185033759619789943,4373729159719107252,9436112687732207258,11147491622908425481,3530627577083617056,7282461502186171305,4905131813300734974,1329728824511012797,3538463834065251974,5058126937344186956,4310145483093826696,8181801960284968256,7254385514381472554,16595664626973803657,14272134818648532763,14590517286947267756,3652187758463808730,11801275577759624853,15864941923675842994,9902085575033411086,17053099823527653151,3655287630781043939,5037312829922913932,7742181642376476956,983139806934121972,8032095530118228018,11117540653173037053,4612108966835618247,8116448218900260443,13145276756664919773,8147619684444845046,3936653196779408216,10276357389647143394,3353687429272094432,3762141080215045820,5185717816621746603,12243961946665422984,7166646138152510922,5391332688019443440,11244189023369239461,1085659520668183455,16479361699275225018,2970205706688320032,12933673260392691249,14012718686318598592,10595805821436967539,9500462277984701481,12813438333982640036,10594676305355342850,9890401993115317196,11540179815470580378,8024814131002501333,1176487381707073899,2832447757181542995,10706198611586030672,13462139077748006791,9864858791498317091,1202812546830396022,9939375440383841058,15318596852196540950,9146671144417124192,2044676181688428777,491804215959401694,13293102323424580390,16867603047532421304,541448662368380046,8264668239652664443,6692346442302391743,14841026479092542982,8006990705428637526,6734068099294386352,1287103169253609179,10671748775990273797,4510875628157770167,9380791664128970305,10886026762558789208,273891544054456983,15960702677334392143,18427709226374413506,13738589166963387654,12017233672048041890,3489610064460554020,12496269562088371796,2849078860318443883,2092547913363397675,18303548206929947303,6277028746173201967,5606099171228990256,4078587169101670095,12380796690938858333,4137423678904181096,1019108421267978874,8522204392796572209,7633511609113008588,17157434749308778556,17967995025769408294,12706555975663500554,3278817959688530741,12027145637872944304,16762000148257987129,15227657438324550220,13470820141600707758,12105606396700739787,14552587108145220010,17329423603739796879,4459768499008519999,7434382844328005764,3351286329119885898,9235960066567513489,1552301877361423346,4356963441887058219,9319537958754055421,11852610174113433771,14694945594051993740,16417305067109370633,16436889779044982624,2881840816569154654,17787432148060327928,17237132901764183128,5899410130031165766,3868823592103429290,16125167729031316098,7304980875157206908,3990012729046364526,5611352391772039464,17343449647169031024,14887488690393689091,10309681268991254277,8365565782351629401,4075122680792506827,5102403187948747314,8015573225982754658,5146500850277752417,5250845236814040021,11516518929884787609,13614195936930117769,8175272395115422172,958372124650274683,1886121208142652460,18301495234419759598,4668299853224453896,7280952050412436479,6923284105869227975,17795628680896699694,16642799123390022382,3094502287591694509,6957132482081243923,7672230191905111244,17419840101851307772,9879130495959384613,6155091809548280770,6960802471601812421,11925192616759593636,5291200940912313290,3027848636493209011,16415051846321256803,11655003606917402815,7887988115873539493,8241094487595300737,14098149363449176679,16750937154635393542,3562266270651769644,15089490398999717987,15688461065658521236,4090850445167344986,4066057788925481215,7057578577504605646,17739579569654884050,3788936728482529786,10574181044575387672,14174290118521327324,8865064416588568669,14932290864471597794,17702047667781177985,11644642678523304443,3326543925552115176,3223759013125838341,3896970559100514103,16571876354251485709,6529909068189691953,13187209980285943292,10297844199631568424,3250278820130127238,9840082524512405065,2257032705111381223,10130510361482594287,4178894358163078210,8452206663927424742,15463975439340314906,14988405702695049861,11639256665499410216,15901863929471269516,12096158571200999091,6643422141420292851,6204488749649139645,10799895318446863605,10253439659013867150,8371774867668646949,15789012798554877540,158873479032403197,1819517830969364736,5576776101146817424,17354767639416099386,1684514667851763819,6620998038633745927,888416482511487952,10848426419226532762,8012411336664439119,6913234367065209184,980975870553928885,18354909980401516150,12083043645748161941,7810395214651745160,1260363615942776034,4806214751149909025,6153065184478256019,6389240177815655226,9162513203106508737,15028323379135955873,3716700039616862902,6528260875086367758,6489277979145837186,11755450154259138022,11180946452462505723,11417385393323575042,13212315070995295672,638831968317529495,8047005171332242076,11372709588782382948,3653945932755431971,14927250508430569726,15956848665971295969,12898874980248623509,14825712129250801300,8714834862839671954,4775335032097305961,5462890601160506997,11710287967052997850,7657777637382434507,5735292568850639011,12893985866928215262,1852852871441609742,16712676557938568558,15033433032787529455,17723671481947335156,17659381963767484580,14206580439720853471,15160643066814868173,5044753071116010649,7052889164993687559,11198542203096644906,3914606854009115816,2818969979998975969,4981112541164863849,16006987370665124801,10754775094567547382,17257277077895761483,13446593969331929845,8804801470958280762,13029369403492814529,15102894396485368399,7552218528904711942,12069652048877336443,3299078794949461379,8015293816115098854,15037642185153828656,16385871705587877693,5068199337609714362,16731504076368016956,17233140989360275688,2283888589652532768,10523162022001240910,12506318992866227653,4953576382043945292,17758141073827744587,3357765922269524001,15416722627112416926,3216999617870694473,16143586242073003249,11514561855310445970,16572710502574272436,11077846213760968660,14642928971579404282,13313458029485926303,1399413590570044192,7888183492965383915,12314869027096730787,10448300258601137972,7976561273448357536,12633153464095976086,1634981250942253158,4331964857257974749,2978014032958873224,10684774359102009642,2407669464818951816,927241153504702945,2235293776681059415,15090515833666581314,972080252249677776,2830217486521983040,12027885622034561953,1444696871387226986,16110060624021533281,16440869396151242432,6331742100441242552,11657148810509104897,16619553478062605430,1493953482481582703,14381446173344490925,8802323686269691242,7528376063122723385,7051011391031647592,53473738690924905,350179905669950629,2680363574250961451,631285359796469169,17455250089433399435,9783994879512167708,353450368719508848,9000537068718151532,11609974775716298938,546176024446459616,13171292824145866244,17558819783022842063,573287257804620371,8227019848408877907,3690766941121495747,14938399100726206543,14672227701056072462,1879019846964139322,8161140593072931725,5976305478794124572,16421343132198618473,10747103538808219288,16771839873208162898,15358785712089329019,16779428271053548179,7213218656094534408,7984968067918093427,5806050899115522145,1088108176859587008,7418528403153434588,8418018775210443162,444386058373067722,10130766503317622892,17133663310376063464,9171495118449710414,6102639085097954430,18080693988083444233,9994163571565852558,7312515297480143250,6838338196291088927,815920016644518530,8817751984890830217,7377122312983957452,9099390726070526929,9490834165184180750,3009851978999209812,15302104513046873641,14905893408759850668,4106109517808691397,7272083056482710889,7100590067021074463,4913323859804096032,16674737106978244917,8451012178162577490,7667094468297577459,16975207137782713545,16167468623000952585,17367259668350460794,18047004136816256194,14428826628843176024,8253463494354724832,10335879884688210640,18317740263367311313,9138985800347068002,1604593368451738230,11789825418889599699,17784970060959288783,13753899568535234205,10447343063344508521,15974899157248198560,7522843209359761926,5230221735676476487,1840133206323685280,4642088100981428837,11146644396372629904,13280866257519271252,8853414817702630908,16487257375455166773,399457002295774663,16062431254440321028,15577740167921540518,545338985377348587,9377203671587903494,5397840025177178507,9372187271583514608,8230219174440293082,13269968706515287680,11930285478048042944,15225492770525991505,5323802756978415838,5884095259366316373,17312970150659673960,10795459508217605596,5394312115309864584,13425457625239431551,4917700336768948730,5401778031442810628,11777380172621093452,8276770025155191822,16694350400008910672,11816647498247035618,6750587738981696873,18032886410852702132,18069450277855151966,5778630102346636225,4148656688862560576,11427111186297778909,5014712049598058401,4237146808917443782,17530390250939100726,3525948976950678430,12926412828014531845,15974184828003556577,7808360916260335363,2400956057598668450,12571474488986408885,1036621425286908012,17247840273067433586,10634328755947215210,17721383187549044235,4016297034846629879,1489153774066924774,2776394076465008373,18108213843772891252,10388771383016117909,17643738985992679570,5113892274679612639,17588709976072292594,18114256932895548942,4729846927172471921,7851960659505798755,16277926811771629944,18205236681291047213,8950103500703202272,6919958146978456064,14718294929427095386,1180536447357472380,13737305545699883765,12583598334013076310,610650606071679626,1401921199830778003,12646030972451670387,6624830754081014080,3524710849603254976,591179975838854812,3290518916593847719,6432046582829852654,2634133080980181220,6982904654358254659,17840520761173579160,13345595097253233494,8599863370583255165,15721708785629120334,88634722089070714,1384096088494479832,16040744267959770068,13448587920174441095,17189793558361844034,2853887762920924774,11684454117628043963,12089949688765261224,7611887051021368479,831361136634202642,15551136795403757969,3961316229032559027,7509697021806046649,6796230684485134422,10391070501364513650,4375886269946976562,7497480128785062988,13943044475518217850,1312400983351233320,2038825697426735923,14099571119327418869,8584483518417829064,15884394992385773944,10701664277734069952,136010168932272201,9912046329085962752,4969863653000803446,5429190589577609311,8422961403061129666,4277396076652053127,6636346564516125192,15230109775144402370,18116852533949568482,8706699538063498811,2831952474709070311,11523626513107549923,3318483226684229870,14040209993505795184,947987508189076123,4383146412495070258,13299092588283967340,10183585564928809672,4915017694224751105,12196006112128315824,13016651603789906601,13041752835189590212,6562126823428979894,9792880764439657081,4616777568693013809,5558447125281821190,1410085843021487481,10470823774606025860,9705884788556795621,13618133915471027380,769516089886722446,3632166807570403611,13733385165890347644,2267033240848041684,6184419409170569269,9824182711811989120,8719941490954625595,5611376461635091352,11073188116577860598,3233574679987667932,9800603612221345353,1974877095183880081,15531861630114067265,4565996441850755052,2109777874203307943,14985563321143825984,13464382886559076410,5994067807374669265,16876178019055428664,13290540668750182905,15184666569934398486,1722433012142174062,2743530972621113761,3971948869676595874,15409373752854610371,6887175474534442810,18080793594752741367,13394384608620504722,11593621974193687981,3783370125592658596,6083242005552627464,1322356504368187699,1729651211401038378,1137922639538814579,337126323809501380,7477269960211700183,12695740214435707065,11540305199117539062,11881615683339323440,13269890793012621010,5918226672074836661,5580034231535727899,18092295725104518547,15604120508063697174,18416570283299742182";
        List<String> keyList = Arrays.asList(keyStr.split(","));
        for (String key : keyList){
            keys.add(key);
        }
        List<Object> bizs = redisService.getHashMultValue("BizzLinkLog", keys,false);
        System.out.println(bizs.getClass());
        StringBuilder stringBuilder = new StringBuilder();
        for (Object biz : bizs){
            stringBuilder.append(biz.toString()).append(",");
        }

        System.out.println(stringBuilder.toString());
    }

    @Test
    public void changeDbIndex(){
        redisService.changeDb(1);
        redisService.set("db1", "db1");

        redisService.changeDb(2);
        redisService.set("db2", "db2");

        new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 100000; i++) {
                    redisService.changeDb(1);
                    String val = redisService.get("db1");
                    Assert.assertTrue("线程不安全", org.apache.commons.lang.StringUtils.isBlank(val));
                }
            }
        }).start();

        new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 100000; i++) {
                    redisService.changeDb(2);
                    String val = redisService.get("db2");
                    Assert.assertTrue("线程不安全", org.apache.commons.lang.StringUtils.isBlank(val));
                }
            }
        }).start();
    }

    @Test
    public void addSetMembers() {
        String key = "set_test";
        redisService.remove(key);
        redisService.addSetMembers(key, "test1", "test2", "test1");

        Set<Object> results = redisService.getSetMembers(key);
        Assert.assertTrue(results.toString().equals("[test2, test1]"));

        redisService.addSetMembers(key, "test1", "test2", "test1");
        results = redisService.getSetMembers(key);
        Assert.assertTrue(results.toString().equals("[test2, test1]"));

        String roleKey = "role_set_test";
        redisService.remove(roleKey);
        Role roleOne = new Role(1, "test", "test1");
        Role roleTwo = new Role(1, "test", "test2");
        redisService.addSetMembers(roleKey, roleOne, roleTwo);

        redisService.addSetMembers(roleKey, roleTwo);
        Set<Object> roles = redisService.getSetMembers(roleKey);
        Assert.assertTrue(roles.size() == 1);
    }

    @Test
    public void isSetMember() {
        String key = "set_test";
        redisService.remove(key);
        redisService.addSetMembers(key, "test1", "test2", "test1");

        Assert.assertTrue(redisService.isSetMember(key, "test1"));
        Assert.assertTrue(redisService.isSetMember(key, "test2"));

        Role roleOne = new Role(1, "test", "test1");
        Role roleTwo = new Role(1, "test", "test2");

        Assert.assertTrue(roleOne.equals(roleTwo));

        String roleKey = "role_set_test";
        redisService.remove(roleKey);
        redisService.addSetMembers(roleKey, roleOne);
        Assert.assertTrue(!redisService.isSetMember(roleKey, roleTwo));

        redisService.addSetMembers(roleKey, roleTwo);

        Assert.assertTrue(redisService.isSetMember(roleKey, roleOne));

    }

    @Test
    public void deleteSetMembers() {

    }
}